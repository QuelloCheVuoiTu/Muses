<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Museo</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css"/>
</head>
<body>
    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="login-container">
            <div class="login-card">
                <h1>üèõÔ∏è Museo</h1>
                
                <div id="loginAlert"></div>
                
                <div class="form-group">
                    <label for="museumId">ID Museo:</label>
                    <input type="text" id="museumId" placeholder="Inserisci ID museo">
                </div>
                
                <div class="form-group">
                    <label for="museumName">Nome Museo:</label>
                    <input type="text" id="museumName" placeholder="Inserisci nome museo">
                </div>
                
                <button class="btn" onclick="login()">Accedi</button>
                
                <div class="register-section">
                    <h3>Registra Nuovo Museo</h3>
                    
                    <div class="form-group">
                        <label for="regName">Nome Museo:</label>
                        <input type="text" id="regName" placeholder="Nome del museo">
                    </div>
                    
                    <div class="form-group">
                        <label for="regDescrizione">Descrizione:</label>
                        <textarea id="regDescrizione" placeholder="Descrizione del museo" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regLatitude">Latitudine:</label>
                            <input type="number" id="regLatitude" step="0.000001" placeholder="es. 52.35778">
                        </div>
                        <div class="form-group">
                            <label for="regLongitude">Longitudine:</label>
                            <input type="number" id="regLongitude" step="0.000001" placeholder="es. 4.87944">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regHours">Orari:</label>
                            <input type="text" id="regHours" placeholder="es. 10:00 - 18:00">
                        </div>
                        <div class="form-group">
                            <label for="regPrice">Prezzo:</label>
                            <input type="text" id="regPrice" placeholder="es. ‚Ç¨18">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regRating">Rating:</label>
                            <input type="number" id="regRating" min="1" max="5" step="0.1" placeholder="es. 4.3">
                        </div>
                        <div class="form-group">
                            <label for="regType">Tipo:</label>
                            <input type="text" id="regType" placeholder="es. Arte contemporanea">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="regImageurl">URL Immagine:</label>
                        <input type="url" id="regImageurl" placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="regParent">Museo Padre:</label>
                        <input type="text" id="regParent" placeholder="es. Rijksmuseum (opzionale)">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="registerMuseum()">Registra Museo</button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-title">Dashboard - <span id="currentMuseumName"></span></div>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('opere')">Opere</button>
                <button class="tab" onclick="showTab('aggiungi')">Aggiungi Opera</button>
                <button class="tab" onclick="showTab('modifica')">Modifica Opera</button>
                <button class="tab" onclick="showTab('elimina')">Elimina Opera</button>
                <button class="tab" onclick="showTab('modificaMuseo')">Modifica Museo</button>
            </div>
            
            <!-- Tab Opere -->
             <div id="opereTab" class="tab-content active">
                <h2>Opere del Museo</h2>
                
                <div id="opereAlert"></div>
                
                <div id="opereLoading" class="loading hidden">
                    <div class="spinner"></div>
                    Caricamento opere...
                </div>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Cerca per nome...">
                    <select id="searchType">
                        <option value="">Tutti i tipi</option>
                    </select>
                    <button class="search-btn" onclick="searchOpere()">Cerca</button>
                </div>
                
                <div id="opereGrid" class="opere-grid"></div>
            </div>
            
            <!-- Tab Aggiungi Opera -->
            <div id="aggiungiTab" class="tab-content">
                <h2>Aggiungi Nuova Opera</h2>
                
                <div id="addAlert"></div>
                
                <form id="addOperaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addNome">Nome Opera:</label>
                            <input type="text" id="addNome" required>
                        </div>
                        <div class="form-group">
                            <label for="addType">Tipo:</label>
                            <input type="text" id="addType" placeholder="es. pittura, scultura, ecc." required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="addDescrizione">Descrizione:</label>
                        <textarea id="addDescrizione" placeholder="Descrizione dell'opera" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="addImageurl">URL Immagine:</label>
                        <input type="url" id="addImageurl" placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-small">Aggiungi Opera</button>
                        <button type="button" class="btn btn-small" onclick="clearAddForm()">Cancella</button>
                    </div>
                </form>
            </div>
            
            <!-- Tab Modifica Opera -->
            <div id="modificaTab" class="tab-content">
                <h2>Modifica Opera</h2>
                
                <div id="modifyAlert"></div>
                
                <div class="form-group">
                    <label for="operaSelect">Seleziona Opera:</label>
                    <select id="operaSelect" onchange="loadOperaForEdit()">
                        <option value="">Seleziona un'opera</option>
                    </select>
                </div>
                
                <form id="modifyOperaForm" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modNome">Nome Opera:</label>
                            <input type="text" id="modNome" required>
                        </div>
                        <div class="form-group">
                            <label for="modType">Tipo:</label>
                            <input type="text" id="modType" placeholder="es. pittura, scultura, ecc." required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="modDescrizione">Descrizione:</label>
                        <textarea id="modDescrizione" placeholder="Descrizione dell'opera" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="modImageurl">URL Immagine:</label>
                        <input type="url" id="modImageurl" placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-small">Modifica Opera</button>
                        <button type="button" class="btn btn-small" onclick="clearModifyForm()">Cancella</button>
                    </div>
                </form>
            </div>
            
            <!-- Tab Elimina Opera -->
            <div id="eliminaTab" class="tab-content">
                <h2>Elimina Opera</h2>
                
                <div id="deleteAlert"></div>
                
                <div class="form-group">
                    <label for="deleteOperaSelect">Seleziona Opera da Eliminare:</label>
                    <select id="deleteOperaSelect">
                        <option value="">Seleziona un'opera</option>
                    </select>
                </div>
                
                <div id="deleteOperaInfo" class="hidden">
                    <div class="opera-card">
                        <h3 id="deleteOperaName"></h3>
                        <p><strong>Tipo:</strong> <span id="deleteOperaAutore"></span></p>
                        <p><strong>Museo:</strong> <span id="deleteOperaTipo"></span></p>
                        <p><strong>Descrizione:</strong> <span id="deleteOperaAnno"></span></p>
                        <p><strong>URL Immagine:</strong> <span id="deleteOperaDescrizione"></span></p>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-danger btn-small" onclick="deleteOpera()" id="deleteConfirmBtn" disabled>Elimina Opera</button>
                </div>
            </div>
            
            <!-- Tab Modifica Museo -->
            <div id="modificaMuseoTab" class="tab-content">
                <h2>Modifica Informazioni Museo</h2>
            
                <div id="modifyMuseumAlert"></div>
                    
                <form id="modifyMuseumForm">
                    <div class="form-group">
                        <label for="modMuseumName">Nome Museo:</label>
                        <input type="text" id="modMuseumName" required>
                    </div>
                        
                    <div class="form-group">
                        <label for="modMuseumDescription">Descrizione:</label>
                        <textarea id="modMuseumDescription" placeholder="Descrizione del museo" required></textarea>
                    </div>
                        
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modMuseumLatitude">Latitudine:</label>
                            <input type="number" id="modMuseumLatitude" step="0.000001" placeholder="es. 52.35778">
                        </div>
                        <div class="form-group">
                            <label for="modMuseumLongitude">Longitudine:</label>
                            <input type="number" id="modMuseumLongitude" step="0.000001" placeholder="es. 4.87944">
                        </div>
                    </div>
                        
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modMuseumHours">Orari:</label>
                            <input type="text" id="modMuseumHours" placeholder="es. 10:00 - 18:00">
                        </div>
                        <div class="form-group">
                            <label for="modMuseumPrice">Prezzo:</label>
                            <input type="text" id="modMuseumPrice" placeholder="es. ‚Ç¨18">
                        </div>
                    </div>
                        
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modMuseumRating">Rating:</label>
                            <input type="number" id="modMuseumRating" min="1" max="5" step="0.1" placeholder="es. 4.3">
                        </div>
                        <div class="form-group">
                            <label for="modMuseumType">Tipo:</label>
                            <input type="text" id="modMuseumType" placeholder="es. Arte contemporanea">
                        </div>
                    </div>
                        
                    <div class="form-group">
                        <label for="modMuseumImageurl">URL Immagine:</label>
                        <input type="url" id="modMuseumImageurl" placeholder="https://example.com/image.jpg">
                    </div>
                        
                    <div class="form-group">
                        <label for="modMuseumParent">Museo Padre:</label>
                        <input type="text" id="modMuseumParent" placeholder="es. Rijksmuseum (opzionale)">
                    </div>
                        
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-small">Modifica Museo</button>
                        <button type="button" class="btn btn-small" onclick="clearModifyMuseumForm()">Cancella</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentMuseum = null;
        let currentOpere = [];
        let selectedOperaId = null;
        
        // API Base URLs
        const HOSTNAME = "http://it.unisannio.muses"
        const OPERE_API = HOSTNAME+'/artworks';
        const MUSEUM_API = HOSTNAME+'/museums';
        const REGISTER_API = HOSTNAME+'/register'
        const LOGIN_API = HOSTNAME+'/login'
        
        // Login function
        async function login() {
            const id = document.getElementById('museumId').value.trim();
            const name = document.getElementById('museumName').value.trim();
            
            if (!id || !name) {
                showAlert('loginAlert', 'Inserisci ID e nome del museo', 'error');
                return;
            }
            
            try {
                // Verify museum exists
                const response = await fetch(`${MUSEUM_API}/getmuseums`);
                const data = await response.json();
                
                // Il server restituisce un oggetto con propriet√† museums contenente l'array
                const museums = data.museums || data;
                
                const museum = museums.find(m => 
                    m._id && m._id.toString() === id && m.name.toLowerCase() === name.toLowerCase()
                );
                
                if (museum) {
                    currentMuseum = museum;
                    showDashboard();
                } else {
                    showAlert('loginAlert', 'Museo non trovato. Verifica ID e nome.', 'error');
                }
            } catch (error) {
                console.error('Errore login:', error);
                showAlert('loginAlert', 'Errore di connessione al server', 'error');
            }
        }
        
        // Register museum function
        async function registerMuseum() {
            const name = document.getElementById('regName').value.trim();
            const description = document.getElementById('regDescrizione').value.trim();
            const latitude = document.getElementById('regLatitude').value;
            const longitude = document.getElementById('regLongitude').value;
            const hours = document.getElementById('regHours').value.trim();
            const price = document.getElementById('regPrice').value.trim();
            const rating = document.getElementById('regRating').value;
            const type = document.getElementById('regType').value.trim();
            const imageurl = document.getElementById('regImageurl').value.trim();
            const parent = document.getElementById('regParent').value.trim();
            
            if (!name || !description) {
                showAlert('loginAlert', 'Nome e descrizione sono obbligatori', 'error');
                return;
            }
            
            const museumData = {
                name: name,
                description: description,
                hours: hours,
                price: price,
                type: type,
                imageurl: imageurl,
                parent: parent
            };
            
            // Add location if provided
            if (latitude && longitude) {
                museumData.location = {
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude)
                };
            }
            
            // Add rating if provided
            if (rating) {
                museumData.rating = parseFloat(rating);
            }
            
            try {
                const response = await fetch(`${MUSEUM_API}/addmuseum`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(museumData)
                });
                
                if (response.ok) {
                    showAlert('loginAlert', 'Museo registrato con successo!', 'success');
                    clearRegisterForm();
                } else {
                    showAlert('loginAlert', 'Errore nella registrazione del museo', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Errore di connessione al server', 'error');
            }
        }

        // Load museum info for editing
        function loadMuseumForEdit() {
            if (!currentMuseum) return;
            
            document.getElementById('modMuseumName').value = currentMuseum.name || '';
            document.getElementById('modMuseumDescription').value = currentMuseum.description || '';
            document.getElementById('modMuseumType').value = currentMuseum.type || '';
            document.getElementById('modMuseumHours').value = currentMuseum.hours || '';
            document.getElementById('modMuseumPrice').value = currentMuseum.price || '';
            document.getElementById('modMuseumRating').value = currentMuseum.rating || '';
            document.getElementById('modMuseumParent').value = currentMuseum.parent || '';
            document.getElementById('modMuseumImageurl').value = currentMuseum.imageurl || '';
            
            // Handle location
            if (currentMuseum.location) {
                document.getElementById('modMuseumLatitude').value = currentMuseum.location.latitude || '';
                document.getElementById('modMuseumLongitude').value = currentMuseum.location.longitude || '';
            }
        }

        function debugApiCall(url, method, data) {
            console.log(`=== API CALL DEBUG ===`);
            console.log(`URL: ${url}`);
            console.log(`Method: ${method}`);
            console.log(`Data:`, data);
            console.log(`Current Museum ID: ${currentMuseum?._id}`);
            console.log(`=====================`);
        }

        // Modify museum form submission
        document.getElementById('modifyMuseumForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous alerts
            document.getElementById('modifyMuseumAlert').innerHTML = '';
            
            if (!currentMuseum || !currentMuseum._id) {
                showAlert('modifyMuseumAlert', 'Errore: ID museo non trovato', 'error');
                return;
            }
            
            const name = document.getElementById('modMuseumName').value.trim();
            const description = document.getElementById('modMuseumDescription').value.trim();
            const latitude = document.getElementById('modMuseumLatitude').value;
            const longitude = document.getElementById('modMuseumLongitude').value;
            const hours = document.getElementById('modMuseumHours').value.trim();
            const price = document.getElementById('modMuseumPrice').value.trim();
            const rating = document.getElementById('modMuseumRating').value;
            const type = document.getElementById('modMuseumType').value.trim();
            const imageurl = document.getElementById('modMuseumImageurl').value.trim();
            const parent = document.getElementById('modMuseumParent').value.trim();
            
            if (!name || !description) {
                showAlert('modifyMuseumAlert', 'Nome e descrizione sono obbligatori', 'error');
                return;
            }
            
            const museumData = {
                name: name,
                description: description,
                hours: hours,
                price: price,
                type: type,
                imageurl: imageurl,
                parent: parent
            };
            
            // Add location if provided
            if (latitude && longitude) {
                museumData.location = {
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude)
                };
            }
            
            // Add rating if provided
            if (rating) {
                museumData.rating = parseFloat(rating);
            }
            
            // Show loading state
            showModifyingStatus();
            
            try {
                debugApiCall(`${MUSEUM_API}/modifymuseum/${currentMuseum._id}`, 'PUT', museumData);
                
                const response = await fetch(`${MUSEUM_API}/modifymuseum/${currentMuseum._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(museumData)
                });
                
                if (response.ok) {
                    // Update currentMuseum object
                    currentMuseum = { ...currentMuseum, ...museumData };
                    
                    // Update dashboard title
                    document.getElementById('currentMuseumName').textContent = currentMuseum.name;
                   
                    // Update currentMuseum object
                    currentMuseum = { ...currentMuseum, ...museumData };

                    // Update dashboard title
                    document.getElementById('currentMuseumName').textContent = currentMuseum.name;

                    // Show persistent success message
                    showAlert('modifyMuseumAlert', '‚úÖ Museo modificato con successo! Le modifiche sono state salvate.', 'success');
                    
                    // Show persistent success message
                    showAlert('modifyMuseumAlert', '‚úÖ Museo modificato con successo! Le modifiche sono state salvate.', 'success');
                    
                    console.log('Museo aggiornato con successo');
                    
                } else {
                    let errorMessage = 'Errore nella modifica del museo';
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage += ': ' + errorData.message;
                        }
                    } catch (e) {
                        errorMessage += ` (Status: ${response.status})`;
                    }
                    
                    showAlert('modifyMuseumAlert', errorMessage, 'error');
                    console.error('Errore risposta server:', response.status, errorMessage);
                }
            } catch (error) {
                console.error('Errore di connessione:', error);
                showAlert('modifyMuseumAlert', '‚ùå Errore di connessione al server. Riprova pi√π tardi.', 'error');
            }
        });

        // Clear modify museum form
        function clearModifyMuseumForm() {
            document.getElementById('modifyMuseumForm').reset();
            document.getElementById('modifyMuseumAlert').innerHTML = '';
            loadMuseumForEdit(); // Reload original data
        }
        
        // Show dashboard
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('currentMuseumName').textContent = currentMuseum.name;
            
            // Aspetta un momento per assicurarsi che il DOM sia pronto
            setTimeout(() => {
                loadOpere();
                loadOpereForSelect();
                loadMuseumForEdit();
            }, 100);
        }
        
        // Logout function
        function logout() {
            currentMuseum = null;
            currentOpere = [];
            selectedOperaId = null;
            
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            
            // Clear forms
            clearLoginForm();
            clearRegisterForm();
            clearAddForm();
            clearModifyForm();
            
            // Reset to first tab WITHOUT calling showTab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Set first tab as active
            document.getElementById('opereTab').classList.add('active');
            document.querySelector('.tab').classList.add('active');
        }
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Load data for specific tabs
        if (tabName === 'opere') {
            loadOpere();
        } else if (tabName === 'modifica' || tabName === 'elimina') {
            loadOpereForSelect();
        } else if (tabName === 'modificaMuseo') {
            loadMuseumForEdit();
        }
        }
        
        // Load opere for current museum - versione corretta
        async function loadOpere() {
            // Controllo di sicurezza
            if (!currentMuseum) {
                console.warn('currentMuseum √® null, impossibile caricare le opere');
                return;
            }
            
            showLoading('opereLoading', true);
            
            try {
                const response = await fetch(`${OPERE_API}/getoperebymuseum/${encodeURIComponent(currentMuseum.name)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Risposta del server:', result); // Debug
                
                // Gestisce la struttura della risposta del server
                const opere = result.data || result;
                
                if (!Array.isArray(opere)) {
                    throw new Error('La risposta del server non contiene un array di opere');
                }
                
                currentOpere = opere;
                displayOpere(opere);
                updateTypeDropdown(opere);
                
                console.log('Opere caricate:', opere.length); // Debug
            } catch (error) {
                console.error('Errore nel caricamento delle opere:', error);
                showAlert('opereAlert', 'Errore nel caricamento delle opere: ' + error.message, 'error');
            } finally {
                showLoading('opereLoading', false);
            }
        }

        // Aggiorna il dropdown dei tipi con i tipi effettivi delle opere del museo
        function updateTypeDropdown(opere) {
            const searchType = document.getElementById('searchType');
            
            // Ottieni tutti i tipi unici dalle opere
            const types = [...new Set(opere.map(opera => opera.type))].sort();
            
            // Ricostruisci il dropdown
            searchType.innerHTML = '<option value="">Tutti i tipi</option>';
            
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                searchType.appendChild(option);
            });
        }
        
        // Display opere in grid - versione migliorata
        function displayOpere(opere) {
            const grid = document.getElementById('opereGrid');
            
            if (!grid) {
                console.error('Elemento opereGrid non trovato');
                return;
            }
            
            if (!opere || opere.length === 0) {
                grid.innerHTML = '<div class="loading">Nessuna opera trovata</div>';
                return;
            }
            
            try {
                const operaCards = opere.map(opera => {
                    // Escaping delle stringhe per evitare problemi con caratteri speciali
                    const safeName = (opera.name || 'Nome non disponibile').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    const safeType = (opera.type || 'Tipo non specificato').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    const safeMuseum = (opera.museum || 'Museo non specificato').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    const safeDescription = (opera.description || 'Nessuna descrizione').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    const safeImageUrl = opera.imageurl ? opera.imageurl.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                    const safeId = opera._id ? opera._id.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                    
                    return `
                        <div class="opera-card">
                            <h3>${safeName}</h3>
                            <p><strong>Tipo:</strong> ${safeType}</p>
                            <p><strong>Museo:</strong> ${safeMuseum}</p>
                            <p><strong>Descrizione:</strong> ${safeDescription}</p>
                            ${safeImageUrl ? `<img src="${safeImageUrl}" alt="${safeName}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-top: 10px;" onerror="this.style.display='none'">` : ''}
                            <div class="opera-actions">
                                <button class="btn-edit" onclick="editOperaQuick('${safeId}')">Modifica</button>
                                <button class="btn-delete" onclick="deleteOperaQuick('${safeId}')">Elimina</button>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = operaCards.join('');
            } catch (error) {
                console.error('Errore nella generazione delle carte opere:', error);
                grid.innerHTML = '<div class="loading">Errore nella visualizzazione delle opere</div>';
            }
        }
        
        // Search opere - versione corretta con controlli di sicurezza
        async function searchOpere() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            
            // Verifica che currentOpere esista
            if (!currentOpere || currentOpere.length === 0) {
                showAlert('opereAlert', 'Nessuna opera caricata. Ricarica la pagina.', 'error');
                return;
            }
            
            showLoading('opereLoading', true);
            
            try {
                let opere = [...currentOpere]; // Crea una copia dell'array
                
                // Filtra per nome se specificato
                if (searchTerm) {
                    opere = opere.filter(opera => 
                        opera.name && opera.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                // Filtra per tipo se specificato
                if (searchType) {
                    opere = opere.filter(opera => opera.type === searchType);
                }
                
                displayOpere(opere);
            } catch (error) {
                console.error('Errore nella ricerca:', error);
                showAlert('opereAlert', 'Errore nella ricerca', 'error');
            } finally {
                showLoading('opereLoading', false);
            }
        }
        
        // Add opera
        document.getElementById('addOperaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const operaData = {
                name: document.getElementById('addNome').value.trim(),
                type: document.getElementById('addType').value.trim(),
                description: document.getElementById('addDescrizione').value.trim(),
                museum: currentMuseum.name,
                imageurl: document.getElementById('addImageurl').value.trim()
            };
            
            try {
                const response = await fetch(`${OPERE_API}/addopera`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(operaData)
                });
                
                if (response.ok) {
                    showAlert('addAlert', 'Opera aggiunta con successo!', 'success');
                    clearAddForm();
                    loadOpere();
                    loadOpereForSelect();
                } else {
                    showAlert('addAlert', 'Errore nell\'aggiunta dell\'opera', 'error');
                }
            } catch (error) {
                showAlert('addAlert', 'Errore di connessione al server', 'error');
            }
        });
        
        // Load opere for select dropdowns
        async function loadOpereForSelect() {
            try {
                const response = await fetch(`${OPERE_API}/getoperebymuseum/${encodeURIComponent(currentMuseum.name)}`);
                const result = await response.json();
                
                // Gestisce la struttura della risposta del server
                const opere = result.data || result;
                
                const operaSelect = document.getElementById('operaSelect');
                const deleteOperaSelect = document.getElementById('deleteOperaSelect');
                
                const options = opere.map(opera => 
                    `<option value="${opera._id}">${opera.name} - ${opera.type}</option>`
                ).join('');
                
                operaSelect.innerHTML = '<option value="">Seleziona un\'opera</option>' + options;
                deleteOperaSelect.innerHTML = '<option value="">Seleziona un\'opera</option>' + options;
            } catch (error) {
                console.error('Errore nel caricamento delle opere per select:', error);
            }
        }
        
        // Load opera for editing
        async function loadOperaForEdit() {
            const operaId = document.getElementById('operaSelect').value;
            
            if (!operaId) {
                document.getElementById('modifyOperaForm').classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${OPERE_API}/getopera/${operaId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Gestisce la struttura della risposta del server
                const opera = result.data || result;
                
                // Riempi i campi del form
                document.getElementById('modNome').value = opera.name || '';
                document.getElementById('modType').value = opera.type || '';
                document.getElementById('modDescrizione').value = opera.description || '';
                document.getElementById('modImageurl').value = opera.imageurl || '';
                
                selectedOperaId = operaId;
                document.getElementById('modifyOperaForm').classList.remove('hidden');
                
                // Pulisci eventuali alert precedenti
                document.getElementById('modifyAlert').innerHTML = '';
                
            } catch (error) {
                console.error('Errore nel caricamento dell\'opera:', error);
                showAlert('modifyAlert', 'Errore nel caricamento dell\'opera: ' + error.message, 'error');
                document.getElementById('modifyOperaForm').classList.add('hidden');
            }
        }
        
        // Modify opera
        document.getElementById('modifyOperaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedOperaId) {
                showAlert('modifyAlert', 'Seleziona un\'opera da modificare', 'error');
                return;
            }
            
            const operaData = {
                name: document.getElementById('modNome').value.trim(),
                type: document.getElementById('modType').value.trim(),
                description: document.getElementById('modDescrizione').value.trim(),
                museum: currentMuseum.name,
                imageurl: document.getElementById('modImageurl').value.trim()
            };
            
            try {
                const response = await fetch(`${OPERE_API}/modifyopera/${selectedOperaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(operaData)
                });
                
                if (response.ok) {
                    showAlert('modifyAlert', 'Opera modificata con successo!', 'success');
                    clearModifyForm();
                    loadOpere();
                    loadOpereForSelect();
                } else {
                    showAlert('modifyAlert', 'Errore nella modifica dell\'opera', 'error');
                }
            } catch (error) {
                showAlert('modifyAlert', 'Errore di connessione al server', 'error');
            }
        });
        
        // Load opera for deletion
        document.getElementById('deleteOperaSelect').addEventListener('change', async function() {
            const operaId = this.value;
            
            if (!operaId) {
                document.getElementById('deleteOperaInfo').classList.add('hidden');
                document.getElementById('deleteConfirmBtn').disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`${OPERE_API}/getopera/${operaId}`);
                const result = await response.json();
                
                // Gestisce la struttura della risposta del server
                const opera = result.data || result;
                
                document.getElementById('deleteOperaName').textContent = opera.name;
                document.getElementById('deleteOperaAutore').textContent = opera.type;
                document.getElementById('deleteOperaTipo').textContent = opera.museum;
                document.getElementById('deleteOperaAnno').textContent = opera.description || 'Nessuna descrizione';
                document.getElementById('deleteOperaDescrizione').textContent = opera.imageurl || 'Nessuna immagine';
                
                document.getElementById('deleteOperaInfo').classList.remove('hidden');
                document.getElementById('deleteConfirmBtn').disabled = false;
                selectedOperaId = operaId;
            } catch (error) {
                showAlert('deleteAlert', 'Errore nel caricamento dell\'opera', 'error');
            }
        });
        
        // Delete opera
        async function deleteOpera() {
            if (!selectedOperaId) {
                showAlert('deleteAlert', 'Seleziona un\'opera da eliminare', 'error');
                return;
            }
            
            if (!confirm('Sei sicuro di voler eliminare questa opera? Questa azione non pu√≤ essere annullata.')) {
                return;
            }
            
            try {
                const response = await fetch(`${OPERE_API}/deleteopera/${selectedOperaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('deleteAlert', 'Opera eliminata con successo!', 'success');
                    
                    // Reset delete form
                    document.getElementById('deleteOperaSelect').value = '';
                    document.getElementById('deleteOperaInfo').classList.add('hidden');
                    document.getElementById('deleteConfirmBtn').disabled = true;
                    selectedOperaId = null;
                    
                    // Reload data
                    loadOpere();
                    loadOpereForSelect();
                } else {
                    showAlert('deleteAlert', 'Errore nell\'eliminazione dell\'opera', 'error');
                }
            } catch (error) {
                showAlert('deleteAlert', 'Errore di connessione al server', 'error');
            }
        }
        
        // Quick edit from opere grid
        function editOperaQuick(operaId) {
            // Switch to modify tab
            showTab('modifica');
            document.querySelector('.tab:nth-child(3)').classList.add('active');
            
            // Set the select value and load the opera
            document.getElementById('operaSelect').value = operaId;
            loadOperaForEdit();
        }
        
        // Quick delete from opere grid
        async function deleteOperaQuick(operaId) {
            if (!confirm('Sei sicuro di voler eliminare questa opera? Questa azione non pu√≤ essere annullata.')) {
                return;
            }
            
            try {
                const response = await fetch(`${OPERE_API}/deleteopera/${operaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('opereAlert', 'Opera eliminata con successo!', 'success');
                    loadOpere();
                    loadOpereForSelect();
                } else {
                    showAlert('opereAlert', 'Errore nell\'eliminazione dell\'opera', 'error');
                }
            } catch (error) {
                showAlert('opereAlert', 'Errore di connessione al server', 'error');
            }
        }
        
        // Utility functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`Container ${containerId} non trovato`);
                return;
            }
            
            container.innerHTML = `<div class="alert alert-${type === 'error' ? 'error' : 'success'}">${message}</div>`;
            
            // Auto-hide success alerts dopo 5 secondi invece di 3
            if (type === 'success') {
                setTimeout(() => {
                    if (container.innerHTML.includes(message)) {
                        container.innerHTML = '';
                    }
                }, 5000);
            }
        }

        function showModifyingStatus() {
            const submitBtn = document.querySelector('#modifyMuseumForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Modifica in corso...';
            submitBtn.disabled = true;
            
            // Ripristina dopo 3 secondi
            setTimeout(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 3000);
        }
        
        // Utility function corretta con controllo di esistenza
        function showLoading(loadingId, show) {
            const loading = document.getElementById(loadingId);
            if (!loading) {
                console.warn(`Elemento con id '${loadingId}' non trovato`);
                return;
            }
            
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }
        
        function clearLoginForm() {
            document.getElementById('museumId').value = '';
            document.getElementById('museumName').value = '';
            document.getElementById('loginAlert').innerHTML = '';
        }
        
        function clearRegisterForm() {
            document.getElementById('regName').value = '';
            document.getElementById('regDescrizione').value = '';
            document.getElementById('regLatitude').value = '';
            document.getElementById('regLongitude').value = '';
            document.getElementById('regHours').value = '';
            document.getElementById('regPrice').value = '';
            document.getElementById('regRating').value = '';
            document.getElementById('regType').value = '';
            document.getElementById('regImageurl').value = '';
            document.getElementById('regParent').value = '';
        }
        
        function clearAddForm() {
            document.getElementById('addOperaForm').reset();
            document.getElementById('addAlert').innerHTML = '';
        }
        
        function clearModifyForm() {
            document.getElementById('modifyOperaForm').reset();
            document.getElementById('operaSelect').value = '';
            document.getElementById('modifyOperaForm').classList.add('hidden');
            document.getElementById('modifyAlert').innerHTML = '';
            selectedOperaId = null;
        }
        
        // Handle Enter key in search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchOpere();
            }
        });
        
        // Initialize tabs on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set up click handlers for tabs
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.addEventListener('click', function() {
                    const tabNames = ['opere', 'aggiungi', 'modifica', 'elimina', 'modificaMuseo'];
                    showTab(tabNames[index]);
                });
            });
        });
    </script>
</body>
</html>